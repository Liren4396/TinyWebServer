# TinyWebServer - 高性能Web服务器

## 项目介绍

TinyWebServer是一个基于C++开发的轻量级高性能Web服务器，支持HTTP协议，能够处理静态资源请求和简单的动态内容生成。服务器采用了多线程和IO复用技术提供并发服务能力，通过模块化设计实现了高可维护性和扩展性。

## 功能特点

- **并发处理**：采用线程池 + 非阻塞socket + epoll实现并发处理
- **双模式并发模型**：支持Reactor和Proactor两种并发模型
- **触发模式**：支持LT（水平触发）和ET（边缘触发）工作模式
- **数据库连接池**：使用连接池管理MySQL连接，避免频繁建立和关闭连接的开销
- **定时器机制**：基于链表实现的定时器，处理非活动连接
- **日志系统**：支持同步/异步日志系统，记录服务器运行状态
- **线程同步机制**：封装了互斥锁、条件变量和信号量，提供对共享资源的安全访问

## 系统架构

整个系统采用模块化设计，主要由以下几个核心组件构成：

```
│
├── 主程序（main）─────┐
│                      ↓
├── Web服务器（WebServer）
│      │
│      ├─── 线程池（ThreadPool）
│      │      └── 工作队列
│      │
│      ├─── HTTP连接处理（http_conn）
│      │      ├── HTTP请求解析
│      │      └── HTTP响应生成
│      │
│      ├─── 定时器（Timer）
│      │      └── 定时器链表
│      │
│      ├─── 数据库连接池（ConnectionPool）
│      │      └── 连接资源管理
│      │
│      └─── 日志系统（Log）
│             ├── 同步写入
│             └── 异步写入（阻塞队列）
│
└── 同步机制（locker、sem、cond）
       └── 线程同步工具
```

## 核心模块

1. **线程池模块**：使用多线程处理并发请求，提高服务器吞吐量
2. **HTTP解析模块**：解析HTTP请求，支持GET和POST方法
3. **定时器模块**：检测并关闭超时的非活动连接
4. **数据库连接池模块**：预先创建多个数据库连接，使用RAII技术管理连接资源
5. **日志模块**：支持同步/异步写入日志，记录服务器运行状态
6. **同步模块**：封装了互斥锁(mutex)、条件变量(condition)和信号量(semaphore)

## 并发模型

### Reactor模式（反应堆模式）
- 主线程负责监听连接请求，将连接任务分发给工作线程
- 工作线程负责处理IO事件（读/写）和业务逻辑处理
- 通过事件监听和事件分发实现并发处理
- 特点：工作线程直接处理IO，避免了线程间的数据传递，适合计算密集型服务

```
┌─────────────┐           ┌─────────────┐
│ 主线程      │           │ 工作线程池   │
│ ┌─────────┐ │           │ ┌─────────┐ │
│ │  接收   │ │  分发连接  │ │ 读取请求│ │
│ │  连接   ├─┼───────────┼─►         │ │
│ └─────────┘ │           │ │ 处理请求│ │
└─────────────┘           │ │         │ │
                          │ │ 发送响应│ │
                          │ └─────────┘ │
                          └─────────────┘
```

### Proactor模式（前摄器模式）
- 主线程处理所有IO事件（包括读写）
- 工作线程只负责业务逻辑处理
- 适合IO密集型应用，实现简单但可能存在数据复制开销

```
┌─────────────┐           ┌─────────────┐
│ 主线程      │           │ 工作线程池   │
│ ┌─────────┐ │           │ ┌─────────┐ │
│ │  接收   │ │           │ │         │ │
│ │  连接   │ │           │ │         │ │
│ ├─────────┤ │  数据拷贝  │ │ 处理业务│ │
│ │ 读取数据├─┼───────────┼─►         │ │
│ ├─────────┤ │           │ │ 逻辑处理│ │
│ │ 发送数据│ │           │ │         │ │
│ └─────────┘ │           │ └─────────┘ │
└─────────────┘           └─────────────┘
```

## 编译运行

1. 确保已安装MySQL开发库
2. 执行make命令编译项目
3. 运行服务器：
   ```
   ./server [端口] [触发模式] [优雅退出] [日志写入方式] [并发模型选择] [数据库连接数量] [线程数量] [是否关闭日志]
   ```

## 核心技术实现

### 线程池实现
- 采用模板类设计，增强代码复用性
- 预先创建工作线程，避免频繁创建和销毁线程的开销
- 使用生产者-消费者模式，主线程作为生产者，工作线程作为消费者
- 通过互斥锁和信号量实现线程同步，保护工作队列
- 支持Reactor和Proactor两种并发模型，通过模式参数切换

### 定时器实现
- 基于升序双向链表实现定时器，按到期时间排序
- 支持添加、调整和删除定时器操作
- 定时处理非活动连接，释放资源
- 使用管道技术，将信号处理与事件处理统一到epoll框架中

### 数据库连接池实现
- 单例模式确保全局唯一的连接池实例
- 预先创建多个数据库连接，减少连接开销
- 使用互斥锁保护连接池的并发访问
- 采用RAII技术（资源获取即初始化）管理连接资源，防止资源泄漏
- 通过信号量控制连接的数量，实现连接限流

### 日志系统实现
- 单例模式实现日志系统
- 支持按天和大小分割日志文件
- 提供同步写入和异步写入两种方式
- 异步写入基于生产者-消费者模型，使用阻塞队列存储日志消息
- 支持四种日志级别：DEBUG、INFO、WARN、ERROR

### HTTP解析实现
- 状态机解析HTTP请求，分为请求行、请求头和请求体三个状态
- 支持GET和POST两种请求方法
- 实现了HTTP响应的生成和发送
- 使用内存映射(mmap)优化文件传输
- 支持HTTP长连接和短连接

### 同步机制封装
- 封装POSIX线程库的互斥锁、条件变量和信号量
- 提供统一的接口，简化线程同步操作
- 采用RAII思想，自动管理资源的获取和释放

## 项目结构
- **threadpool/**: 线程池实现，提供并发处理能力
- **http/**: HTTP请求处理模块，包括解析和响应生成
- **CGImysql/**: 数据库连接池，管理数据库连接资源
- **timer/**: 定时器模块，处理超时连接
- **log/**: 日志系统，记录服务器运行状态
- **lock/**: 同步机制封装，提供线程同步工具
- **root/**: 静态资源根目录

## 项目价值
TinyWebServer体现了Linux环境下服务器开发的核心知识点，包括：
- 网络编程中的socket和TCP/IP协议应用
- 多线程和线程同步技术
- IO多路复用技术（epoll）
- 数据库编程与连接池设计
- 服务器状态监控与日志系统
- C++面向对象编程和设计模式应用（单例模式、生产者-消费者模式、RAII等） 